#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

mkdir -p $CACHE_DIR

echo "-----> Fetching PHP binaries"
PHP_PACKAGE="http://redima-composer-buildpack.s3.amazonaws.com/php-5.4.tgz"
curl $PHP_PACKAGE -s -o - | tar xzf - -C $BUILD_DIR

PATH="$BUILD_DIR/bin:$PATH"

echo "-----> Installing Composer"
COMPOSER_URL="https://getcomposer.org/composer.phar"
curl $COMPOSER_URL -s -o $BUILD_DIR/bin/composer
COMPOSER=$BUILD_DIR/bin/composer
chmod +x $COMPOSER

export COMPOSER_VENDOR_DIR=$CACHE_DIR/vendor
mkdir -p $COMPOSER_VENDOR_DIR
echo "       Using composer vendor dir: $COMPOSER_VENDOR_DIR"
cd $BUILD_DIR
composer install
cd $LP_DIR